SetEnvIf Request_URI "^.*" LOCALHOST=https://localhost/shell
SetEnvIf Request_URI "^.*" LIVEHOST=https://shell.com
SetEnvIf Host localhost SCHEME=https://
SetEnvIf Host localhost HOST=localhost
SetEnvIf Host localhost BASE_PATH=/shell/
SetEnvIf Host !localhost SCHEME=https://
SetEnvIf Host !localhost HOST=shell.com
SetEnvIf Host !localhost BASE_PATH=/
<IfModule mod_rewrite.c>
	RewriteEngine On
	RewriteRule ^ - [E=BASE_URL:%{ENV:SCHEME}%{ENV:HOST}%{ENV:BASE_PATH}]
</IfModule>
<If "req('Host') = 'localhost'">
	<IfModule mod_headers.c>
		Header set Cache-Control "no-cache, no-store, must-revalidate"
		Header set Pragma "no-cache"
		Header set Expires 0
	</IfModule> 
</If>
AddDefaultCharset utf-8
<IfModule mod_mime.c>
    AddCharset utf-8 .appcache \
                     .atom \
                     .css \
                     .js \
                     .json \
                     .manifest \
                     .map \
                     .mjs \
                     .rdf \
                     .rss \
                     .vtt \
                     .webmanifest \
                     .xml
    AddType text/xml                                    xml
    AddType application/json                            json
    AddType application/rss+xml                         rss
    AddType application/json                            map
    AddType application/javascript                      js mjs
    AddType application/manifest+json                   webmanifest
    AddType text/cache-manifest                         appcache
    AddType audio/mp4                                   f4a f4b m4a
    AddType audio/ogg                                   oga ogg spx
    AddType video/mp4                                   mp4 mp4v mpg4
    AddType video/ogg                                   ogv
    AddType video/webm                                  webm
    AddType video/x-flv                                 flv
    AddType image/svg+xml                               svgz
    AddType image/x-icon                                cur
    AddType image/webp                                  webp
    AddType application/vnd.ms-fontobject               eot
    AddType font/woff                                   woff
    AddType font/woff2                                  woff2
    AddType font/ttf                                    ttf
    AddType font/collection                             ttc
    AddType font/otf                                    otf
    AddType text/vtt                                    vtt
</IfModule>
<IfModule mod_rewrite.c>
    <IfModule mod_headers.c>
        RewriteEngine On
        Options +FollowSymlinks
            RewriteCond "%{HTTP:Accept-encoding}" "br"
            RewriteCond "%{HTTPS}" "on"
            RewriteCond "%{REQUEST_FILENAME}\.br" "-s"
            RewriteRule "^(.*)" "$1\.br" [QSA]
            RewriteRule "\.(ico|cur)\.br$"      "-" [T=image/x-icon,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.(md|markdown)\.br$"  "-" [T=text/markdown,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.appcache\.br$"       "-" [T=text/cache-manifest,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.atom\.br$"           "-" [T=application/atom+xml,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.bmp\.br$"            "-" [T=image/bmp,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.css\.br$"            "-" [T=text/css,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.eot.\.br$"           "-" [T=application/vnd.ms-fontobject,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.geojson\.br$"        "-" [T=application/vnd.geo+json,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.html?\.br$"          "-" [T=text/html,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.ics\.br$"            "-" [T=text/calendar,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.json\.br$"           "-" [T=application/json,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.jsonld\.br$"         "-" [T=application/ld+json,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.m?js\.br$"           "-" [T=application/javascript,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.otf\.br$"            "-" [T=font/otf,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.rdf\.br$"            "-" [T=application/rdf+xml,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.rss\.br$"            "-" [T=application/rss+xml,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.svg\.br$"            "-" [T=image/svg+xml,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.ttc\.br$"            "-" [T=font/collection,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.ttf\.br$"            "-" [T=font/ttf,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.txt\.br$"            "-" [T=text/plain,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.vc(f|ard)\.br$"      "-" [T=text/vcard,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.vtt\.br$"            "-" [T=text/vtt,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.webmanifest\.br$"    "-" [T=application/manifest+json,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.xhtml\.br$"          "-" [T=application/xhtml+xml,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.xml\.br$"            "-" [T=text/xml,E=no-brotli:1,E=no-gzip:1]
            <FilesMatch "\.br$">
                Header append Content-Encoding br
            </FilesMatch>
            RewriteCond "%{HTTP:Accept-encoding}" "gzip"
            RewriteCond "%{REQUEST_FILENAME}\.gz" "-s"
            RewriteRule "^(.*)" "$1\.gz" [QSA]
            RewriteRule "\.(ico|cur)\.gz$"      "-" [T=image/x-icon,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.(md|markdown)\.gz$"  "-" [T=text/markdown,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.appcache\.gz$"       "-" [T=text/cache-manifest,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.atom\.gz$"           "-" [T=application/atom+xml,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.bmp\.gz$"            "-" [T=image/bmp,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.css\.gz$"            "-" [T=text/css,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.eot.\.gz$"           "-" [T=application/vnd.ms-fontobject,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.geojson\.gz$"        "-" [T=application/vnd.geo+json,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.html?\.gz$"          "-" [T=text/html,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.ics\.gz$"            "-" [T=text/calendar,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.json\.gz$"           "-" [T=application/json,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.jsonld\.gz$"         "-" [T=application/ld+json,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.m?js\.gz$"           "-" [T=application/javascript,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.otf\.gz$"            "-" [T=font/otf,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.rdf\.gz$"            "-" [T=application/rdf+xml,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.rss\.gz$"            "-" [T=application/rss+xml,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.svg\.gz$"            "-" [T=image/svg+xml,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.ttc\.gz$"            "-" [T=font/collection,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.ttf\.gz$"            "-" [T=font/ttf,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.txt\.gz$"            "-" [T=text/plain,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.vc(f|ard)\.gz$"      "-" [T=text/vcard,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.vtt\.gz$"            "-" [T=text/vtt,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.webmanifest\.gz$"    "-" [T=application/manifest+json,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.xhtml\.gz$"          "-" [T=application/xhtml+xml,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.xml\.gz$"            "-" [T=text/xml,E=no-brotli:1,E=no-gzip:1]
            <FilesMatch "\.gz$">
                Header append Content-Encoding gzip
            </FilesMatch>
        <FilesMatch "\.(br|gz)$">
            Header append Vary Accept-Encoding
        </FilesMatch>
    </IfModule>
</IfModule>
<IfModule mod_deflate.c>
    <IfModule mod_filter.c>
        AddOutputFilterByType DEFLATE "application/atom+xml" \
                                      "application/json" \
                                      "application/manifest+json" \
                                      "application/rdf+xml" \
                                      "application/rss+xml" \
                                      "application/schema+json" \
                                      "application/vnd.ms-fontobject" \
                                      "application/xhtml+xml" \
                                      "font/collection" \
                                      "font/opentype" \
                                      "font/otf" \
                                      "font/ttf" \
                                      "image/bmp" \
                                      "image/svg+xml" \
                                      "image/x-icon" \
                                      "text/cache-manifest" \
                                      "text/css" \
                                      "text/html" \
                                      "application/javascript" \
                                      "text/plain" \
                                      "text/vtt" \
                                      "text/xml"
    </IfModule>
    <IfModule mod_mime.c>
        AddEncoding gzip              svgz
    </IfModule>
</IfModule>
<IfModule mod_expires.c>
    ExpiresActive on
    ExpiresDefault                                   "access plus 1 year"
        ExpiresByType text/cache-manifest            "access plus 0 seconds"
        <Files "favicon.ico">
            ExpiresByType image/x-icon               "access plus 1 year"
        </Files>
        ExpiresByType application/atom+xml           "access plus 1 hour"
        ExpiresByType application/rdf+xml            "access plus 1 hour"
        ExpiresByType application/rss+xml            "access plus 1 hour"
        ExpiresByType application/json               "access plus 0 seconds"
        ExpiresByType application/ld+json            "access plus 0 seconds"
        ExpiresByType application/schema+json        "access plus 0 seconds"
        ExpiresByType application/vnd.geo+json       "access plus 0 seconds"
        ExpiresByType text/xml                       "access plus 0 seconds"
        ExpiresByType text/html                      "access plus 0 seconds"
    <IfModule mod_headers.c>
        Header merge Cache-Control immutable
        <FilesMatch "\.(appcache|cur|geojson|json(ld)?|x?html?|topojson|xml)$">
            Header edit Cache-Control immutable ""
        </FilesMatch>
    </IfModule>
</IfModule>
<IfModule mod_headers.c>
    Header always set Strict-Transport-Security "max-age=31536000"
    Header always set X-Content-Type-Options nosniff
    Header set X-XSS-Protection: "1; mode=block"
    <FilesMatch "\.(appcache|atom|bbaw|bmp|crx|css|cur|eot|f4[abpv]|flv|geojson|gif|htc|ic[os]|jpe?g|m?js|json(ld)?|m4[av]|manifest|map|markdown|md|mp4|oex|og[agv]|opus|otf|pdf|png|rdf|rss|safariextz|svgz?|swf|topojson|tt[cf]|txt|vcard|vcf|vtt|webapp|web[mp]|webmanifest|woff2?|xloc|xml|xpi)$">
        Header unset Content-Security-Policy
        Header unset X-Content-Security-Policy
        Header unset X-UA-Compatible
        Header unset X-WebKit-CSP
        Header unset X-XSS-Protection
    </FilesMatch>
    Header unset Expires
    Header unset Host
    Header unset P3P
    Header unset Pragma
    Header unset Public-Key-Pins
    Header unset Public-Key-Pins-Report-Only
    Header unset Via
    Header unset X-AspNet-Version
    Header unset X-AspNetMvc-version
    Header unset X-Frame-Options
    Header unset X-Powered-By
    Header unset X-Runtime
    Header unset X-Version
	Header set Connection keep-alive
	Header set Referrer-Policy same-origin
</IfModule>
ServerSignature Off
<Files .htaccess>
	order allow,deny
	deny from all
</Files>
<If "req('Host') = 'localhost'">
	ErrorDocument 400 https://localhost/shell/error/?400
	ErrorDocument 403 https://localhost/shell/error/?403
	ErrorDocument 404 /shell/error/
	ErrorDocument 500 https://localhost/shell/error/?500
</If>
<If "req('Host') != 'localhost'">
	ErrorDocument 400 https://shell.com/error/?400
	ErrorDocument 403 https://shell.com/error/?403
	ErrorDocument 404 /error/
	ErrorDocument 500 https://shell.com/error/?500
</If>
Options +FollowSymLinks -MultiViews
Options -Indexes
<IfModule mod_rewrite.c>
	RewriteEngine On
	RewriteCond %{HTTP_HOST} =localhost
	RewriteCond %{REQUEST_FILENAME} !-f
	RewriteCond %{DOCUMENT_ROOT}%{ENV:BASE_PATH}maintenance_on -f
	RewriteCond %{DOCUMENT_ROOT}%{ENV:BASE_PATH}pages/maintenance/ -d
	RewriteCond %{REQUEST_URI} !/maintenance/$ [NC]
	RewriteCond %{REQUEST_URI} !/shell/maintenance/$ [NC]
	RewriteRule ^(.*)$ /%{ENV:BASE_PATH}maintenance/ [L]
	RewriteCond %{HTTPS} !=on
	RewriteRule ^/?(.*) https://%{ENV:HOST}%{ENV:BASE_PATH}$1 [R=301,L]
	RewriteCond %{HTTP_HOST} ^www\.
	RewriteRule ^(.*)$ %{ENV:BASE_URL}$1 [R=301,L]
	RewriteRule ^((ftp|https?):\/\/)?(.*)\.((?=.*\d)[a-z\d]+)?\.(css|ico|jpe?g|m?js|json|png|gif|svg|xml|webp|webmanifest|mp4|webm|ogv)$ $1$3.$5 [L]
# NOTE: The REQUEST_URI will ALWAYS begin with a slash!
# NOTE: The PATTERN in the RewriteRule will NEVER begin with a slash!
# You're working out what to put in the PATH after the slash in the domain
# (really, in the folder in which the .htaccess file is found).

# Target: The root itself
# Pattern: If it's an empty string...
# Condition 1: If it's not a file
# Condition 2: If it is a directory
# PATH rewrite: "home/"
#
# '' -> home/
#
	RewriteCond %{REQUEST_FILENAME} !-f
	RewriteCond %{REQUEST_FILENAME} -d
	RewriteRule ^$ home/

# Target: Filename off the root (link must open it)
# Pattern: If it's a string without a slash...
# Condition 1: If it's not a file
# Condition 2: If it's not a directory
# Condition 3: If it does not begin with "/home/"
# Condition 4: URI with at least one dot but no slashes before or after it,
# with a leading slash (which REQUEST_URIs will always have, so must be built
# into the pattern).
# PATH Rewrite: Prepend "home/" 
# (IMPORTANT: We will splice in "/pages/" in the next step)
#
# abc.file -> home/abc.file
#
	RewriteCond %{REQUEST_FILENAME} !-f
	RewriteCond %{REQUEST_FILENAME} !-d
	RewriteCond %{REQUEST_URI} !^/home/
	RewriteCond %{REQUEST_URI} !^/shell/home/
	RewriteCond %{REQUEST_URI} ^.*\/(?:$|[^\/]*\.[^\/]*)$
	RewriteRule ^([^\/]*)$ home/$1

# Target: Filename in "Home" that does not yet have "/pages/" prepended to it:
# Pattern: Zero or more of ANY characters, with at least one dot somewhere in the middle
# Condition 1: If it's not a file
# Condition 2: If it's not a directory
# Condition 3: URI not beginning with "/pages/"
# PATH Rewrite: Prepend "pages/"
#
# home/abc.file -> pages/home/abc.file
# random/abc.file -> pages/random/abc.file
#
	RewriteCond %{REQUEST_FILENAME} !-f
	RewriteCond %{REQUEST_FILENAME} !-d
	RewriteCond %{REQUEST_URI} !^/pages/
	RewriteCond %{REQUEST_URI} !^/shell/pages/
	RewriteRule ^(.*\..*)$ pages/$1

# Target: path not beginning with "/pages/" and NO DOTS
# Condition 1: If it's not a file
# Condition 2: If it's not a directory
# Condition 3: URI doesn't begin with "/pages"
# Condition 4: URI isn't a dot
# PATH Rewrite: Prepend "pages/" and append "/"
#
# home/abc -> pages/home/abc/
# random -> pages/random/
#
	RewriteCond %{REQUEST_FILENAME} !-f
	RewriteCond %{REQUEST_FILENAME} !-d
	RewriteCond %{REQUEST_URI} !^/pages/
	RewriteCond %{REQUEST_URI} !^/shell/pages/
	RewriteCond %{REQUEST_URI} !\.
	RewriteRule ^([^.]*)$ pages/$1/

### REDIRECT TO ERROR PAGE (404) IF, BY NOW, IT DOESN'T MATCH AN ACTUAL FILE OR FOLDER ###
### NOTE: JavaScript must send 404 status code when loading this page ###
# Pattern: If it's passed through all the above rules, and it's anything at all...
# Condition 1: If it's not a file
# Condition 2: If it's not a directory
# PATH Rewrite: Go directly to error/ page
	RewriteCond %{REQUEST_FILENAME} !-f
	RewriteCond %{REQUEST_FILENAME} !-d
	RewriteRule ^(.*)$ error/ [L,R=404]

### BLOCK DIRECT ACCESSS TO PRIVATE AND PAGES FOLDER (403 error) ###
### NOTE: RENAME /shell/ TO ACTUAL LOCALHOST ###
# Pattern: Anything
# Condition 1: Is or is not localhost
# Condition 2: Not by POST
# Condition 3: If the request begins with either /shell/private/ or /shell/pages/
# PATH Rewrite: Fail [F], sending to 403 ErrorDocument, and make last rewrite [L].
# LOCALHOST:
	RewriteCond %{HTTP_HOST} =localhost
	RewriteCond %{REQUEST_METHOD} !POST
	RewriteCond %{THE_REQUEST} /shell/(private|pages)/ [NC]
	RewriteRule ^ - [F,L]
# LIVEHOST:
	RewriteCond %{HTTP_HOST} !=localhost
	RewriteCond %{REQUEST_METHOD} !POST
	RewriteCond %{THE_REQUEST} /(private|pages)/ [NC]
	RewriteRule ^ - [F,L]

# Pattern: Any string (^ = beginning)
# Rewrite: Do nothing
# BUT...
# The rewrites will fail unless the assignment of ABSOLUTE_ROOT is done as part of the same line
# It sets the prefix for ALL the rewrites above.
# Note that this is where $_SERVER['ABSOLUTE_ROOT'] is set for PHP routines.
	RewriteRule ^ - [E=ABSOLUTE_ROOT:%{DOCUMENT_ROOT}%{ENV:BASE_PATH}]

</IfModule>